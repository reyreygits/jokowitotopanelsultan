<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Admin TOKPED4D</title>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDzikWeuSIoMTCC6wsD64NnX5bLQQvM2dA",
  authDomain: "ariptoto-93af7.firebaseapp.com",
  projectId: "ariptoto-93af7",
  storageBucket: "ariptoto-93af7.appspot.com",
  messagingSenderId: "703805134804",
  appId: "1:703805134804:web:402e7f9e378ae1ecdb2841"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
</script>

<style>
body { margin:0; font-family:Arial,sans-serif; background:#0a0f1c; color:white; }
header { background:#111a33; padding:10px 20px; text-align:center; }
header h1 { color:#FFD700; }
table { width:100%; border-collapse:collapse; margin-top:20px; }
th, td { padding:8px; border:1px solid #FFD700; text-align:center; color:#FFD700; }
button { padding:6px 10px; border:none; border-radius:4px; cursor:pointer; margin:2px; font-weight:bold; }
.btn-approve { background:#00cc66; color:white; }
.btn-reject { background:#ff4444; color:white; }
</style>
</head>

<body>
<header>
<h1>Admin Panel - TOKPED4D</h1>
</header>

<div style="padding:20px;">
<h2>Pending Deposit & Withdraw</h2>
<table>
<thead>
<tr>
<th>User</th>
<th>Type</th>
<th>Amount</th>
<th>Status</th>
<th>Actions</th>
</tr>
</thead>
<tbody id="historyTable">
<!-- Data akan muncul di sini -->
</tbody>
</table>
</div>

<script>
// --- Load Pending History ---
function loadPending(){
  db.collection("history").where("status","==","Pending").orderBy("date","desc").get().then(snap=>{
    const tbody = document.getElementById("historyTable");
    tbody.innerHTML="";
    snap.forEach(doc=>{
      const d = doc.data();
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${d.user}</td>
        <td>${d.type}</td>
        <td>Rp ${d.amount}</td>
        <td>${d.status}</td>
        <td>
          <button class="btn-approve" onclick="approve('${doc.id}','${d.user}','${d.type}',${d.amount})">Approve</button>
          <button class="btn-reject" onclick="reject('${doc.id}')">Reject</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  });
}

// --- Approve Transaction ---
function approve(docId,userId,type,amount){
  const userRef = db.collection("users").doc(userId);
  db.runTransaction(async (transaction)=>{
    const userDoc = await transaction.get(userRef);
    if(!userDoc.exists) throw "User tidak ditemukan";
    let newBalance = userDoc.data().balance;
    if(type==="Deposit") newBalance += amount;
    if(type==="Withdraw") {
      if(newBalance<amount){ alert("Saldo user tidak cukup!"); return; }
      newBalance -= amount;
    }
    transaction.update(userRef,{balance:newBalance});
    transaction.update(db.collection("history").doc(docId),{status:"Approved"});
  }).then(()=>{ alert("Transaction approved!"); loadPending(); })
    .catch(err=>{ console.error(err); alert("Error approve"); });
}

// --- Reject Transaction ---
function reject(docId){
  db.collection("history").doc(docId).update({status:"Rejected"})
    .then(()=>{ alert("Transaction rejected"); loadPending(); });
}

// Load data saat halaman dibuka
window.onload = loadPending;
</script>
</body>
</html>
