<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>MAXBET4D - Admin Panel</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDzikWeuSIoMTCC6wsD64NnX5bLQQvM2dA",
  authDomain: "AIzaSyDzikWeuSIoMTCC6wsD64NnX5bLQQvM2dA",
  projectId: "ariptoto-93af7",
  storageBucket: "ariptoto-93af7.appspot.com",
  messagingSenderId: "703805134804",
  appId: "1:703805134804:web:402e7f9e378ae1ecdb2841"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
</script>

<style>
body { font-family: Arial, sans-serif; background: #0a0f1c; color: white; margin: 0; padding: 0; }
header { background: #111a33; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
.logo { font-size: 24px; font-weight: bold; color: #FFD700; }
.search-bar { margin: 20px; display: flex; gap: 10px; flex-wrap: wrap; }
.search-bar input { padding: 8px; border-radius: 6px; border: none; width: 300px; font-size: 14px; }
.search-bar button { padding: 8px 15px; background: #FFD700; color: #000; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
table { width: 95%; margin: 20px auto; border-collapse: collapse; background: #1a1f33; border-radius: 8px; overflow: hidden; }
th, td { padding: 10px; text-align: center; border: 1px solid #333; }
th { background: #222; color: #FFD700; }
td { background: #2a2a2a; }
input.editable { width: 120px; padding: 6px; border-radius: 4px; border: none; text-align: center; background: #444; color: white; }
.btn-action { padding: 6px 10px; margin: 2px; border-radius: 4px; cursor: pointer; border: none; font-weight: bold; }
.btn-delete { background: #ff4444; color: white; }
.btn-approve { background: #00cc66; color: white; }
.btn-reject { background: #ff6666; color: white; }
h2 { margin-left: 20px; margin-top: 30px; border-left: 4px solid #FFD700; padding-left: 10px; }
.pagination { text-align: center; margin-bottom: 30px; }
.pagination button { padding: 8px 15px; margin: 5px; border-radius: 6px; background: #FFD700; border: none; color: #000; font-weight: bold; cursor: pointer; }
.status-badge { padding:4px 8px; border-radius:6px; font-weight:bold; }
.status-pending { background: #ffcc00; color: #000; }
.status-approved { background: #00cc66; color: #000; }
.status-rejected { background: #ff4444; color: #fff; }
.container { max-width:1200px; margin:0 auto; }
</style>
</head>

<body>
<header><div class="logo">ARIPTOTO - Admin Panel</div></header>

<div class="search-bar">
  <input type="text" id="searchInput" placeholder="Cari UserID / Nama Rekening / No Rekening">
  <button onclick="loadAdminData()">üîç Cari</button>
  <button onclick="loadAdminData()">üîÑ Refresh</button>
</div>

<div class="container">
<h2>üìã Users List</h2>
<table id="usersTable">
  <thead>
    <tr>
      <th>UserID</th><th>Password</th><th>Nama Rekening</th><th>No Rekening</th><th>Bank</th><th>Phone</th><th>Balance</th><th>Aksi</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>
<div class="pagination">
  <button onclick="prevPage()">‚èÆÔ∏è Sebelumnya</button>
  <button onclick="nextPage()">‚è≠Ô∏è Berikutnya</button>
</div>

<h2>üí≥ Deposit List</h2>
<table id="depositsTable">
  <thead>
    <tr>
      <th>UserID</th><th>Amount</th><th>Status</th><th>Created At</th><th>Aksi</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<h2>üèß Withdraw List</h2>
<table id="withdrawsTable">
  <thead>
    <tr>
      <th>UserID</th><th>Amount</th><th>Status</th><th>Created At</th><th>Aksi</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>
</div>

<script>
let usersData = [];
let currentPage = 1;
const usersPerPage = 12;

// helper format tanggal
function fmtDate(ts){
  if(!ts) return '';
  try{
    if(ts.toDate) return ts.toDate().toLocaleString();
    return new Date(ts).toLocaleString();
  }catch(e){ return String(ts); }
}

// ======== Load Data Admin ========
async function loadAdminData(){
  const searchVal = document.getElementById('searchInput').value.trim().toLowerCase();

  // --- Ambil data semua users ---
  const usersSnap = await db.collection('users').orderBy('createdAt','desc').get();
  usersData = [];
  usersSnap.forEach(u=>{
    const data = u.data();
    const match = !searchVal ||
                  u.id.toLowerCase().includes(searchVal) ||
                  (data.namaRekening && data.namaRekening.toLowerCase().includes(searchVal)) ||
                  (data.rekening && data.rekening.toLowerCase().includes(searchVal));
    if(match) usersData.push({ id: u.id, ...data });
  });
  currentPage = 1;
  renderUsers();

  // --- Deposit List ---
  const depsT = document.getElementById('depositsTable').querySelector('tbody');
  depsT.innerHTML = '';
  const depsSnap = await db.collection('deposits').orderBy('createdAt','desc').get();
  depsSnap.forEach(d=>{
    const data = d.data();
    const tr = document.createElement('tr');
    const dateStr = fmtDate(data.createdAt);
    tr.innerHTML = `
      <td>${data.user}</td>
      <td>Rp ${data.amount}</td>
      <td><span class="status-badge ${data.status==='pending'?'status-pending':(data.status==='approved'?'status-approved':'status-rejected')}">${data.status}</span></td>
      <td>${dateStr}</td>
      <td>
        ${data.status === 'pending' ? `
          <button class="btn-action btn-approve" onclick="approveDeposit('${d.id}')">Approve</button>
          <button class="btn-action btn-reject" onclick="rejectDeposit('${d.id}')">Reject</button>
        ` : '-'}
      </td>
    `;
    if(data.status === 'pending') depsT.prepend(tr); else depsT.appendChild(tr);
  });

  // --- Withdraw List ---
  const wT = document.getElementById('withdrawsTable').querySelector('tbody');
  wT.innerHTML = '';
  const wSnap = await db.collection('withdraws').orderBy('createdAt','desc').get();
  wSnap.forEach(d=>{
    const data = d.data();
    const tr = document.createElement('tr');
    const dateStr = fmtDate(data.createdAt);
    tr.innerHTML = `
      <td>${data.user}</td>
      <td>Rp ${data.amount}</td>
      <td><span class="status-badge ${data.status==='pending'?'status-pending':(data.status==='approved'?'status-approved':'status-rejected')}">${data.status}</span></td>
      <td>${dateStr}</td>
      <td>
        ${data.status === 'pending' ? `
          <button class="btn-action btn-approve" onclick="approveWithdraw('${d.id}')">Approve</button>
          <button class="btn-action btn-reject" onclick="rejectWithdraw('${d.id}')">Reject</button>
        ` : '-'}
      </td>
    `;
    if(data.status === 'pending') wT.prepend(tr); else wT.appendChild(tr);
  });
}

// ======== Render Users dengan Pagination ========
function renderUsers(){
  const usersT = document.getElementById('usersTable').querySelector('tbody');
  usersT.innerHTML = '';
  const start = (currentPage-1)*usersPerPage;
  const end = start + usersPerPage;
  const pageUsers = usersData.slice(start,end);
  pageUsers.forEach(u=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${u.id}</td>
      <td><input class="editable" value="${u.password || ''}" onchange="updateUserField('${u.id}','password',this.value)"></td>
      <td><input class="editable" value="${u.namaRekening || ''}" onchange="updateUserField('${u.id}','namaRekening',this.value)"></td>
      <td><input class="editable" value="${u.rekening || ''}" onchange="updateUserField('${u.id}','rekening',this.value)"></td>
      <td><input class="editable" value="${u.bank || ''}" onchange="updateUserField('${u.id}','bank',this.value)"></td>
      <td><input class="editable" value="${u.phone || ''}" onchange="updateUserField('${u.id}','phone',this.value)"></td>
      <td><input class="editable" type="number" value="${u.balance || 0}" onchange="updateUserField('${u.id}','balance',parseInt(this.value)||0)"></td>
      <td>
        <button class="btn-action btn-delete" onclick="deleteUser('${u.id}')">Hapus</button>
        <button class="btn-action btn-approve" onclick="resetPasswordPrompt('${u.id}')">Reset Pass</button>
      </td>
    `;
    usersT.appendChild(tr);
  });
}

// ======== Pagination ========
function nextPage(){
  if(currentPage*usersPerPage < usersData.length){
    currentPage++;
    renderUsers();
  }
}
function prevPage(){
  if(currentPage > 1){
    currentPage--;
    renderUsers();
  }
}

// ======== Aksi ========
async function deleteUser(uid){
  if(!confirm(`Hapus user ${uid}?`)) return;
  try{
    await db.collection('users').doc(uid).delete();
    alert('‚úÖ User dihapus');
    loadAdminData();
  }catch(e){ console.error(e); alert('Gagal menghapus'); }
}

async function resetPasswordPrompt(uid){
  const newPass = prompt(`Password baru untuk ${uid}:`);
  if(newPass){
    try{
      await db.collection('users').doc(uid).update({ password: newPass });
      alert('üîê Password direset');
      loadAdminData();
    }catch(e){ console.error(e); alert('Gagal reset'); }
  }
}

async function updateUserField(uid, field, value){
  try{
    await db.collection('users').doc(uid).update({ [field]: value });
  }catch(e){ console.error(e); alert('Gagal update field'); }
}

// ======== Deposit Approve/Reject ========
async function approveDeposit(depId){
  if(!confirm('Setujui deposit ini?')) return;
  const depDoc = await db.collection('deposits').doc(depId).get();
  if(!depDoc.exists){ alert('Tidak ditemukan'); return; }
  const depData = depDoc.data();

  try{
    // update deposit status
    await db.collection('deposits').doc(depId).update({ status: 'approved' });
    // tambah saldo user
    await db.collection('users').doc(depData.user).update({
      balance: firebase.firestore.FieldValue.increment(depData.amount)
    });
    alert('‚úÖ Deposit disetujui & saldo diperbarui');
    loadAdminData();
  }catch(e){ console.error(e); alert('Gagal approve deposit'); }
}

async function rejectDeposit(depId){
  if(!confirm('Tolak deposit ini?')) return;
  try{
    await db.collection('deposits').doc(depId).update({ status: 'rejected' });
    alert('‚ùå Deposit ditolak');
    loadAdminData();
  }catch(e){ console.error(e); alert('Gagal menolak'); }
}

// ======== Withdraw Approve/Reject ========
async function approveWithdraw(wId){
  if(!confirm('Setujui withdraw ini? (saldo akan dikurangi)')) return;
  const wDoc = await db.collection('withdraws').doc(wId).get();
  if(!wDoc.exists){ alert('Tidak ditemukan'); return; }
  const wData = wDoc.data();

  try{
    // check balance before reducing (optional safety)
    const userDoc = await db.collection('users').doc(wData.user).get();
    const userData = userDoc.data();
    if(!userData){ alert('User tidak ditemukan'); return; }
    if((userData.balance || 0) < wData.amount){
      if(!confirm('Saldo user kurang dari amount. Tetap kurangi dan approve?')) {
        return;
      }
    }

    await db.collection('withdraws').doc(wId).update({ status: 'approved' });
    await db.collection('users').doc(wData.user).update({
      balance: firebase.firestore.FieldValue.increment(-wData.amount)
    });
    alert('‚úÖ Withdraw disetujui & saldo dikurangi');
    loadAdminData();
  }catch(e){ console.error(e); alert('Gagal approve withdraw'); }
}

async function rejectWithdraw(wId){
  if(!confirm('Tolak withdraw ini?')) return;
  try{
    await db.collection('withdraws').doc(wId).update({ status: 'rejected' });
    alert('‚ùå Withdraw ditolak');
    loadAdminData();
  }catch(e){ console.error(e); alert('Gagal menolak withdraw'); }
}

// ======== Auto load saat halaman terbuka ========
loadAdminData();
</script>
</body>
</html>
